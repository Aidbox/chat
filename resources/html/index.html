<html>
    <head>
        <style>
         .flex-row {
             display: flex;
         }
         .flex-column {
             display: flex;
             flex-direction: column;
         }
         #messages {
             max-height: 600px;
             overflow: scroll;
         }
        </style>
    </head>
    <body>
        <div class="flex-column">
            <div id="messages">
            </div>
            <input id="roomName"/>
            <textarea id="message"></textarea>
            <button id="send">Send</button>
            </div>
        </div>
    </body>
    <script>
     function messageTemplate(item) {
         return `<p><b>${item.timestmap} (${item["message-index"]})</b><br/>${item.text}</p>`;
     }
     function parseQuery(queryString) {
         const query = {};
         const pairs = (queryString[0] === '?' ? queryString.substr(1) : queryString).split('&');
         for (let i = 0; i < pairs.length; i++) {
             const pair = pairs[i].split('=');
             query[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
         }
         return query;
     }

     const search = parseQuery(window.location.search);
     const host = window.location.host;
     let lastId = 0;
     let chat = [];

     let roomId = search.room;
     if (roomId){
         window.roomName.value = roomId;
     }


     window.roomName.onchange = (e) => {
         roomId = e.target.value;
     }

     function addNewMessage(e) {
         const text = window.message.value;
         sendMessage({text, id: lastId + 1});
         window.message.value = "";
     }

     window.message.onkeydown = (e) => {
         if(e.ctrlKey && e.keyCode === 13) {
             addNewMessage(e);
         }
     }

     window.send.onclick = addNewMessage

     function sendMessage(message) {
         fetch(`//${host}/${roomId}`,{
             method: 'POST',
             body: JSON.stringify(message),
         });
     }

     window.messages.onscroll = (e) => {
         if(e.target.scrollTop === 0){
             loadHistory();
         }
     }

     function loadHistory() {
         if(chat.length) {
             const history = chat[0]["message-index"];
             fetch(`//${host}/${roomId}?history=${history}`)
                 .then(response => response.text())
                 .then(parseJSON)
                 .then(data  => {
                     if(data.length) {
                         chat = data.concat(chat);
                         window.messages.innerHTML =
                             data.map(messageTemplate).join('') + window.messages.innerHTML;
                     }
                 });
         }
     }

     function parseJSON(text) {
         if(text.length === 0) {
             return [];
         }
         let start = 0;
         let result = [];
         let prevChar = "";
         for(let current = 0; current < text.length; current ++){
             const currentChar = text[current];
             if(prevChar === "}" && currentChar === "{") {
                 const json = text.substr(start, current - start);
                 result.push(JSON.parse(json));
                 start = current;
             }
             prevChar = currentChar;
         }
         const json = text.substr(start);
         result.push(JSON.parse(json));
         return result;
     }

     setInterval(() => {
         if(!roomId) {
             return;
         }
         let offset = "";
         if(lastId > 0){
             offset = `?offset=${lastId + 1}`;
         }
         fetch(`//${host}/${roomId}${offset}` )
             .then(response => response.text())
             .then(parseJSON)
             .then(data  => {
                 if(data.length) {
                     chat = chat.concat(data);
                     lastId = data[data.length - 1]["message-index"];
                     window.messages.innerHTML +=
                         data.map(messageTemplate) .join('');
                     window.messages.scrollTop = window.messages.lastChild.offsetTop;
                     if(offset === "" && data.length < 100) {
                         loadHistory();
                     }
                 }
             });
     }, 500);
    </script>
</html>
